[{"id":"a5ef9a2a.0da6d8","type":"function","z":"7c668a6b.54a1c4","name":"Updata DB format","func":"var debug = context.global.debug;\nvar deviceDbTools = context.global. deviceDbTools;\nvar moment = context.global.momentModule;\nnode.warn('Updata DB format');\n\n\ndeviceDbTools.findAllDevices(function(err,devices){\n    if(err){\n        console.log(err);\n    }\n    for(var i = 0; i < devices.length; i++){\n        if(debug){\n            node.warn('devices ('+i+'): '+devices[i]);\n        }\n        \n        if(isTarget(devices[i])){\n            /*Find delete target*/\n\n            if(debug){\n                node.warn('Updata DB format delete: '+devices[i].macAddr + ', type :'+devices[i].index);\n                break;\n            }\n            delDeviceById(devices[i]);\n           \n        }else{\n            if(debug){\n                node.warn('Updata DB format update: '+devices[i].macAddr + ', type :'+devices[i].index)\n            }\n            if(devices[i].info.data0){\n                //console.log('info : '+devices[i].info);\n                updateDevice(devices[i]);\n            }\n        }\n    }\n});\n\nfunction isTarget(device){\n    var mac = device.macAddr;\n    if(mac === '040004b8'){\n        return true;\n    }else{\n        return false;\n    }\n}\n\nfunction updateDevice(device){\n    var mInfo = {};\n    //console.log('@@@@ device info:'+JSON.stringify(device.info));\n    var mData = device.data;\n    var mType =  mData.substring(0,4);\n    if(mType === 'aa00'){\n        mInfo.temperature  = device.info.data0;\n        mInfo.humidity     = device.info.data1;\n        mInfo.voltage      = device.info.data2;\n    }else if(mType === 'aa03'){\n        mInfo.frmaldehyde  = device.info.data0;\n        mInfo.co2          = device.info.data1;\n        mInfo.temperature  = device.info.data2;\n        mInfo.humidity     = device.info.data3;\n        mInfo.co           = device.info.data4;\n        mInfo.pm10         = device.info.data5;\n        mInfo.pm25         = device.info.data6;\n        mInfo.tvoc         = device.info.data7;\n    }else if(mType === 'aa01'){\n        mInfo.pressure     = device.info.data0;\n        mInfo.temperature  = device.info.data1;\n        mInfo.humidity     = device.info.data2;\n        mInfo.light        = device.info.data3;\n        mInfo.uv           = device.info.data4;\n        mInfo.rain         = device.info.data5;\n    }\n    var momObj = moment(device.recv_at);\n    var mTime =  momObj.format('YYYY-MM-DD HH:mm:ss');\n    var json = {info:mInfo,time:mTime};\n    deviceDbTools.updateDeviceData(device._id,json);\n}\n\nfunction saveDevice(device){\n    console.log('mac : '+ device.macAddr);\n    console.log('data : '+ device.data);\n    console.log('recv_at : '+ device.recv_at);\n    deviceDbTools.saveDevice(device.macAddr,device.data,device.recv_at,function(err,info){\n        console.log('Debug save Device -----------------------------');\n        if(err){\n            console.log('Debug save Device fail : '+err);\n            return;\n        }\n        console.log('Debug save Device success ');\n        console.log('Debug info.voltage : '+info.data4);\n    });\n    delDeviceById(device._id);\n}\n\nfunction delDeviceById(device){\n    var _id = device._id;\n    console.log('_id : '+ _id);\n    deviceDbTools.removeDeviceById(_id,function(err,result){\n        console.log('Debug remove Device By Id -----------------------------');\n        if(err){\n            console.log('Debug remove Device By Id fail : '+err);\n        }\n        console.log('Debug remove Device By Id success ');\n    });\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":330.75,"y":74.5,"wires":[[]]},{"id":"3d273b90.623814","type":"inject","z":"7c668a6b.54a1c4","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":121,"y":72,"wires":[["a5ef9a2a.0da6d8"]]}]